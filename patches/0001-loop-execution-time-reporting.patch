From fb40b5a5c0279a585f03ce42253ff7352fed2869 Mon Sep 17 00:00:00 2001
From: Uday Bondhugula <udayreddy@gmail.com>
Date: Sun, 18 Aug 2013 12:07:55 +0530
Subject: [PATCH] loop execution time reporting

Signed-off-by: Uday Bondhugula <udayreddy@gmail.com>
---
 include/cloog/clast.h |    6 ++++++
 source/clast.c        |    3 +++
 source/pprint.c       |   13 ++++++++++++-
 3 files changed, 21 insertions(+), 1 deletions(-)

diff --git a/include/cloog/clast.h b/include/cloog/clast.h
index fd56dd7..1698d21 100644
--- a/include/cloog/clast.h
+++ b/include/cloog/clast.h
@@ -104,10 +104,13 @@ struct clast_for {
     cloog_int_t		stride;
     struct clast_stmt *	body;
     int parallel;
+    int time;
     /* Comma separated list of loop private variables for OpenMP parallelization */
     char *private_vars;
     /* Comma separated list of reduction variable/operators for OpenMP parallelization */
     char *reduction_vars;
+    /* Variable name to accumulate execution time this loop */
+    char *time_name;
 };
 
 struct clast_equation {
@@ -170,6 +173,9 @@ typedef struct clastFilter{
 void clast_filter(struct clast_stmt *node, ClastFilter filter,
         struct clast_for ***loops, int *nloops, int **stmts, int *nstmts);
 
+/* UB: expose this for debug purposes */
+void pprint_expr(struct cloogoptions *i, FILE *dst, struct clast_expr *e);
+
 #if defined(__cplusplus)
   }
 #endif 
diff --git a/source/clast.c b/source/clast.c
index 78143c3..1700116 100644
--- a/source/clast.c
+++ b/source/clast.c
@@ -213,6 +213,7 @@ static void free_clast_for(struct clast_stmt *s)
     cloog_clast_free(f->body);
     if (f->private_vars) free(f->private_vars);
     if (f->reduction_vars) free(f->reduction_vars);
+    if (f->time_name) free(f->time_name);
     free(f);
 }
 
@@ -229,8 +230,10 @@ struct clast_for *new_clast_for(CloogDomain *domain, const char *it,
     f->UB = UB;
     f->body = NULL;
     f->parallel = CLAST_PARALLEL_NOT;
+    f->time = 0;
     f->private_vars = NULL;
     f->reduction_vars = NULL;
+    f->time_name = NULL;
     cloog_int_init(f->stride);
     if (stride)
 	cloog_int_set(f->stride, stride->stride);
diff --git a/source/pprint.c b/source/pprint.c
index 2db7542..d77e01d 100644
--- a/source/pprint.c
+++ b/source/pprint.c
@@ -70,7 +70,8 @@ static void pprint_minmax_c(struct cloogoptions *info,
 			FILE *dst, struct clast_reduction *r);
 static void pprint_reduction(struct cloogoptions *i,
 			FILE *dst, struct clast_reduction *r);
-static void pprint_expr(struct cloogoptions *i, FILE *dst, struct clast_expr *e);
+/* UB: added this to cloog.h */
+/* static void pprint_expr(struct cloogoptions *i, FILE *dst, struct clast_expr *e); */
 static void pprint_equation(struct cloogoptions *i,
 			FILE *dst, struct clast_equation *eq);
 static void pprint_assignment(struct cloogoptions *i, FILE *dst, 
@@ -406,6 +407,9 @@ void pprint_for(struct cloogoptions *options, FILE *dst, int indent,
 		 struct clast_for *f)
 {
     if (options->language == CLOOG_LANGUAGE_C) {
+        if (f->time) {
+            fprintf(dst, "IF_TIME(%s_start = rtclock());\n", (f->time_name)?f->time_name:"");
+        }
         if ((f->parallel & CLAST_PARALLEL_OMP) && !(f->parallel & CLAST_PARALLEL_MPI)) {
             if (f->LB) {
                 fprintf(dst, "lbp=");
@@ -529,6 +533,13 @@ void pprint_for(struct cloogoptions *options, FILE *dst, int indent,
 	fprintf(dst,"END DO\n") ; 
     else
 	fprintf(dst,"}\n") ; 
+
+    if (options->language == CLOOG_LANGUAGE_C) {
+        if (f->time) {
+            fprintf(dst, "IF_TIME(%s += rtclock() - %s_start);\n",
+                    (f->time_name)?f->time_name:"", (f->time_name)?f->time_name:"");
+        }
+    }
 }
 
 void pprint_stmt_list(struct cloogoptions *options, FILE *dst, int indent,
-- 
1.7.7.6

