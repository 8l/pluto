From b2b5d389e81f61de893a27b10aa35c0b3d2ab867 Mon Sep 17 00:00:00 2001
From: Uday Bondhugula <uday@csa.iisc.ernet.in>
Date: Tue, 1 Sep 2015 11:08:36 +0530
Subject: [PATCH 3/4] cloog invariant decls print option

Signed-off-by: Uday Bondhugula <uday@csa.iisc.ernet.in>
---
 include/cloog/options.h |  5 +++--
 source/options.c        | 13 ++++++++++---
 source/pprint.c         | 38 ++++++++++++++++++++------------------
 3 files changed, 33 insertions(+), 23 deletions(-)

diff --git a/include/cloog/options.h b/include/cloog/options.h
index f4dd70e..b4d9303 100644
--- a/include/cloog/options.h
+++ b/include/cloog/options.h
@@ -60,8 +60,9 @@ struct cloogoptions
 {
   CloogState *state; /* State. */
   /* OPTIONS FOR LOOP GENERATION */
-  int l ;           /* Last level to optimize. */
-  int f ;           /* First level to optimize. */
+  int l ;             /* Last level to optimize. */
+  int f ;             /* First level to optimize. */
+  int invariant_decl; /* Print (specified) loop invariant declarations of statement(s) */
 
   int *ls;         /* Last level to optimize (statement-wise). */
   int *fs;         /* First level to optimize (statement-wise). */
diff --git a/source/options.c b/source/options.c
index 3689c0c..6f7f22f 100644
--- a/source/options.c
+++ b/source/options.c
@@ -120,8 +120,9 @@ void cloog_options_print(FILE * foo, CloogOptions * options)
 
   fprintf(foo,"Options:\n") ;
   fprintf(foo,"OPTIONS FOR LOOP GENERATION\n") ;
-  fprintf(foo,"l           = %3d,\n",options->l) ;
-  fprintf(foo,"f           = %3d,\n",options->f) ;
+  fprintf(foo,"l              = %3d,\n",options->l) ;
+  fprintf(foo,"f              = %3d,\n",options->f) ;
+  fprintf(foo,"invariant_decl = %3d,\n",options->invariant_decl) ;
   fprintf(foo,"fs           = %3d,\n",options->f) ;
   if (options->fs_ls_size>=1) {
       fprintf(foo,"fs           = ");
@@ -205,7 +206,9 @@ void cloog_options_help()
   "  -l <depth>            Last loop depth to optimize (-1: infinity)\n"
   "                        (default setting: -1).\n"
   "  -f <depth>            First loop depth to start loop separation (-1: "
-  "infinity)\n                        (default setting:  1).\n") ;
+  "infinity)\n                        (default setting:  1).\n"
+  "  -invariant_decl <boolean>    Print (specified) loop invariant declarations"
+  " of statement(s)\n             (default setting: 0).\n") ;
   printf(
   "  -stop <depth>         Loop depth to stop code generation (-1: infinity)"
   "\n                        (default setting: -1).\n"
@@ -334,6 +337,7 @@ CloogOptions *cloog_options_malloc(CloogState *state)
   /* OPTIONS FOR LOOP GENERATION */
   options->l           = -1 ;  /* Last level to optimize: infinity. */
   options->f           =  1 ;  /* First level to optimize: the first. */
+  options->invariant_decl = 0; /* No loop invariant declarations to print */
   options->ls          = NULL ; /* Statement-wise l option is not set */
   options->fs          = NULL ; /* Statement-wise f option is not set */
   options->fs_ls_size  = 0;    /* No statement-wise f/s control */
@@ -395,6 +399,9 @@ void cloog_options_read(CloogState *state, int argc, char **argv,
     if (strcmp(argv[i],"-f")   == 0)
     cloog_options_set(&(*options)->f,argc,argv,&i) ;
     else
+    if (strcmp(argv[i],"-invariant_decl")   == 0)
+    cloog_options_set(&(*options)->invariant_decl,argc,argv,&i) ;
+    else
     if (strcmp(argv[i],"-stop")   == 0)
     cloog_options_set(&(*options)->stop,argc,argv,&i) ;
     else
diff --git a/source/pprint.c b/source/pprint.c
index ad432b2..6339297 100644
--- a/source/pprint.c
+++ b/source/pprint.c
@@ -507,31 +507,33 @@ void pprint_for(struct cloogoptions *options, FILE *dst, int indent,
                 pprint_expr(options, dst, f->UB);
                 fprintf(dst, ";\n");
             }
-            FILE *fp = fopen("__temp.s", "a+");
-            if (fp != NULL) {
-                pprint_stmt_list(options, fp, 0, f->body);
+            if (options->invariant_decl) {
+                FILE *fp = fopen("__temp.s", "a+");
+                if (fp != NULL) {
+                    pprint_stmt_list(options, fp, 0, f->body);
 
-                char *temp_str = (char *)malloc(1024);
-                temp_str[0] = 0;
+                    char *temp_str = (char *)malloc(1024);
+                    temp_str[0] = 0;
 
-                rewind(fp);
+                    rewind(fp);
 
-                fprintf(dst, "%*s", indent, "");
-                fprintf(dst, "##if (defined __DATA_DIST_DECLS || defined USE_LOCAL_ARRAYS)\n");
+                    fprintf(dst, "%*s", indent, "");
+                    fprintf(dst, "##if (defined __DATA_DIST_DECLS || defined USE_LOCAL_ARRAYS)\n");
 
-                while (fgets(temp_str, 1024, fp)) {
-                    char *str = pprint_replacestr(temp_str, "S", "decl_S");
-                    if (str) {
-                        fprintf(dst, "%*s", indent, "");
-                        fprintf(dst, "%s", str);
+                    while (fgets(temp_str, 1024, fp)) {
+                        char *str = pprint_replacestr(temp_str, "S", "decl_S");
+                        if (str) {
+                            fprintf(dst, "%*s", indent, "");
+                            fprintf(dst, "%s", str);
+                        }
                     }
-                }
 
-                fprintf(dst, "%*s", indent, "");
-                fprintf(dst, "##endif\n");
+                    fprintf(dst, "%*s", indent, "");
+                    fprintf(dst, "##endif\n");
 
-                fclose(fp);
-                remove("__temp.s");
+                    fclose(fp);
+                    remove("__temp.s");
+                }
             }
 
             fprintf(dst, "%*s#pragma ivdep\n", indent, "");
-- 
2.4.3

